@page "/"
@inject IScratcherDb ScratcherDb
@inject NavigationManager NavigationManager


<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.
<br />
<h3>Scartch Card List</h3>
<div>
    <QuickGrid Items="@AllCards"Class="table table-striped">
        <PropertyColumn Property="@(card => card.Id)" Title="Card-Id" />
        <PropertyColumn Property="@(card => card.Name)" />
        <PropertyColumn Property="@(card => card.StartNumber)" />
        <PropertyColumn Property="@(card => card.EndNumber)" />
        <PropertyColumn Property="@(card => card.TicketPrice)" Title="Ticket Price" />
        <PropertyColumn Property="@(card => (card.EndNumber - card.StartNumber) * card.TicketPrice)" Title="Amount" />
        <TemplateColumn Title="Actions">
            <button @onclick="@(() => HandleEdit(context.Id))">Edit</button>
            <button @onclick="@(() => HandleDeleteAsync(context))">Delete</button>
        </TemplateColumn>
        
    </QuickGrid>
</div>
<div>Total Amount = @Sum.ToString("C2")</div>
@code
{
    private IQueryable<Card>? AllCards{get; set;}


    private decimal Sum{get; set;}


    private decimal CardTotal{get; set;}

    protected override async Task OnInitializedAsync()
    {
        await RefreshCardList();
        if(AllCards is not null && AllCards.ToList().Count == 0)
        {
            foreach(var x in InitialList())
            {
                await ScratcherDb.SaveCardAsync(x);
            }
        }
       await RefreshCardList(); 

    }

    private async Task RefreshCardList()
    {

        AllCards = (await ScratcherDb.GetCardsAsync()).AsQueryable();
    }

    protected override async Task OnParametersSetAsync()
    {
        await RefreshCardList();
        if(AllCards is null)
        {
            CardTotal = 0;

        }

        foreach(var x in AllCards)
        {
            CardTotal = (x.EndNumber - x.StartNumber) * x.TicketPrice;
            Sum += CardTotal;
        }


        await Task.CompletedTask;
    }

    private void HandleEdit(int cardId)
    {
        if(cardId == 0)
        {
            return;
        }
        NavigationManager.NavigateTo($"/cardedit/{cardId}");

    }



    private async Task HandleDeleteAsync(Card card)
    {
        if(card is  null)
        {
            return;
        }

       
       await ScratcherDb.DeleteCardAsync(card);
       await RefreshCardList();
        
       //NavigationManager.NavigateTo("/");
    }

private static  List<Card> InitialList()
    {
        List<Card> cards = new()
            {
                new Card{Name = "a", StartNumber = 1, EndNumber = 35, TicketPrice = 5},
                new Card{Name = "b", StartNumber = 0, EndNumber = 0, TicketPrice = 0},
                new Card{Name = "c", StartNumber = 3, EndNumber = 34, TicketPrice = 10},
                new Card{Name = "d", StartNumber = 0, EndNumber = 0, TicketPrice = 0},
                new Card{Name = "e", StartNumber = 0, EndNumber = 0, TicketPrice = 0}     

            };
            return cards;
    }
   
}
